<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>test</title>
    <link rel="preload" href="./assets/fonts/BravuraText-1.271.woff" as="font">
    <script type="text/javascript" src="fumen2.js"></script>
    <style>
        /*
        @font-face {
        font-family: 'Bravura Text';
        src: url('./assets/fonts/BravuraText-1.271.woff') format('woff');
        }*/
        /*
        @font-face {
        font-family: 'Bravura';
        src: url('./assets/fonts/Bravura-1.271.woff') format('woff');
        }*/

        #sample {
            /*font-family:'Bravura Text';*/
            font-family:'Bravura';
            font-size: 40px;
        }

        .glyphtable td{
            border: 1px solid gray;
        }

        .bravura {
            font-family:'Bravura Text';
            /*font-family:'Bravura';*/
            font-size: 24px;
        }

        .desc {
            font-size: 12px;
        }
    </style>
    <script type="text/javascript">
    /*function SetupHiDPICanvas(canvas, w, h, ratio, zoom) {
        var ctx = canvas.getContext("2d");
        var G_zoom = zoom;
        canvas.width = w * ratio * G_zoom;
        canvas.height = h * ratio * G_zoom;
        canvas.style.width = w * G_zoom + "px";
        canvas.style.height = h * G_zoom + "px";
        ctx.setTransform(ratio * G_zoom, 0, 0, ratio * G_zoom, 0, 0);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        return { ratio: ratio };
    }*/

    function loadFont(){
        var font = new FontFace("Bravura Text", "url(./assets/fonts/BravuraText-1.271.woff)");

        // don't wait for the render tree, initiate an immediate fetch!
        font.load().then(function() {
            // apply the font (which may re-render text and cause a page reflow)
            // after the font has finished downloading
            document.fonts.add(font);
            console.log("Font loaded");
            //document.body.style.fontFamily = "Awesome Font, serif";

            // OR... by default the content is hidden,
            // and it's rendered after the font is available
            //var content = document.getElementById("content");
            //content.style.visibility = "visible";

            // OR... apply your own render strategy here...
        });
    }

    function toHex(v) {
        return '0x' + (('0000' + v.toString(16).toUpperCase()).substr(-4));
    }

    function view(){
        var pmeta = getJSON("./assets/fonts/bravura_metadata-1.271.json");

        // Standard smufl  glyphnames mapping. 
        // Note legatures, alternate glyphs are not in the scope of smufl spec.
        // (Just define the range of codes for these gralypcs but does not specify any specific mapping)
        var p = getJSON("./assets/fonts/glyphnames.json"); // From https://raw.githubusercontent.com/w3c/smufl/gh-pages/metadata/glyphnames.json
        Promise.all([pmeta, p]).then(function(jsons){
            var metadata = jsons[0];
            var glyphnames = jsons[1];
            console.log(metadata);
            var codeToNameMap = {};
            for(key in glyphnames){
                var codeInt = parseInt(glyphnames[key].codepoint.replace("U+","0x"));
                codeToNameMap[codeInt] = key;
            }
 

            var s = document.getElementById("all");
            var code = 0xE000;
            var html = "<table class='glyphtable'>";
            var cols = 4;
            var rowhtml = "";
            for(; code < 0xF8FF; ++code){
                var name = (code in codeToNameMap ? codeToNameMap[code] : "");
                var bboxstr = "";
                if(name in metadata.glyphBBoxes){
                    var bbox = metadata.glyphBBoxes[name];
                    bboxstr = "["+(bbox.bBoxSW+"")+"],["+(bbox.bBoxNE+"")+"]";
                }
                rowhtml += ("<td class='bravura'>"+(
                    String.fromCodePoint(0xE014)+
                    String.fromCodePoint(code)+"</td>"+
                    "<td class='desc'>"+toHex(code)+"<br>"+name+" " + bboxstr + "</td>"));
                if(code%cols==cols-1){
                    html += "<tr>"+rowhtml+"</tr>";
                    rowhtml = "";
                }
                
            }
            s.innerHTML = html + "</table>";

            //console.log(codeToNameMap);
            
            var canvas = document.getElementById("canvas");
            Fumen.SetupHiDPICanvas(canvas, 600, 600, 2, 1);
            var ctx = canvas.getContext("2d");
            ctx.font = '29.61px "Bravura Text"';
            ctx.textBaseline = "top";
            ctx.textAlign = "center";
            ypos = 50;
            for(var i = 0; i < 10; ++i){
                ctx.moveTo(0, i*10);
                ctx.lineTo(100, i*10);
                ctx.stroke();
            }
            ctx.fillText(String.fromCodePoint(0xE014), 10, ypos);
            ctx.fillText(String.fromCodePoint(0xE050), 20, ypos);
            ctx.fillText(String.fromCodePoint(0xE084), 30, ypos);
            //ctx.fillText(String.fromCodePoint(0xF5BA), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF5BB), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF55C), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF55D), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF57D), 10, ypos);
            //ctx.fillText(String.fromCodePoint(0xF57E), 10, ypos);
            
        });
    }

    function SyncStaff(interval){
        // Synchtornize to 5 line staff with interval assuming "top" align
        //console.log(codeToNameMap);
        var canvas = document.getElementById("canvas");
        Fumen.SetupHiDPICanvas(canvas, 600, 600, 2, 1); // To configure global ratio, firstly call this.

        var memcanvas = document.getElementById("memcanvas");
        Fumen.SetupHiDPICanvas(memcanvas, 600, 600, 2, 1); // To configure global ratio, firstly call this.

        var lineThickNessShift = 0.064; // This is from BBox file aviaalble in Bravura github, as a ratio to interval. This can be considred as a half of line width
        
        // NOTE : Currenly the screening is start from x=y=0. Drawings behid 0,0, are not checked.
        var fontSize = Fumen.getFontSizeFromHeight(interval*4 + lineThickNessShift*interval, 
            "Bravura Text", 
            String.fromCodePoint(0xE014), 
            0.1, {"canvas":memcanvas}); // Get estimated font size.
        
        console.log("font size = "+fontSize);
        var ctx = canvas.getContext("2d");
        ctx.font = fontSize+'px "Bravura Text"';
        ctx.textBaseline = "top";
        var ypos = 50;
        for(var i = 0; i < 5; ++i){
            ctx.moveTo(0, ypos + i*interval);
            ctx.lineTo(500, ypos + i*interval);
            ctx.stroke();
        }
        ctx.fillText(String.fromCodePoint(0xE014), 0, ypos);

        ctx.textAlign = "end";
        ctx.fillText(String.fromCodePoint(0xE080), 0, ypos);

        console.log("Measure text");
        console.log( ctx.measureText(String.fromCodePoint(0xE080)) );
    }

    function getJSON(url) {
        return new Promise(function(resolve, reject){
            var req = new XMLHttpRequest();						// XMLHttpRequest オブジェクトを生成する
            req.onreadystatechange = function() {				// XMLHttpRequest オブジェクトの状態が変化した際に呼び出されるイベントハンドラ
                if(req.readyState == 4 && req.status == 200){	// サーバーからのレスポンスが完了し、かつ、通信が正常に終了した場合

                    var data = JSON.parse(req.responseText);	// 取得した JSON ファイルの中身を変数へ格納
                    /*var len = data.length;						// JSON のデータ数を取得

                    // JSON のデータ数分処理
                    for(var i=0; i<len; i++) {
                        console.log("id: " + data[i].id + ", name: " + data[i].name);
                    }*/
                    //console.log(data);

                    resolve(data);

                }
            };
            //req.open("GET", "./assets/fonts/bravura_metadata-1.271.json", false);				// HTTPメソッドとアクセスするサーバーのURLを指定
            req.open("GET", url, false);				// HTTPメソッドとアクセスするサーバーのURLを指定
            
            req.send(null);										// 実際にサーバーへリクエストを送信
        });
    }
    </script>
</head>
<body>
    <div><button onclick="view()">View Fonts</button>
        <button onclick="SyncStaff(6)">Sync Staff</button>
        <button onclick="loadFont()">LoadFont</button>
    </div>
    <!--https://w3c.github.io/smufl/gitbook/tables/repeats.html-->
    <!--<p id="sample">
        &#xE040; &#xE014; &#xE050; &#xE014; &#xE260; &#xE014; &#xE261; &#xE014; &#xE262; </br>
        &#xE014;&#xE09F;&#xE085;&#xE09E;&#xE089; </br>
        &#xF5EC; &#xF5AF; </br>
        &#xF5BA; &#xF5BB; </br>
        &#xF5AA;
    </p>-->
    <canvas id="canvas" style="width:100%; height:600px;"></canvas>
    <canvas id="memcanvas"></canvas>
    <p id="all"></p>
</body>
</html>