<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>test</title>
    <script type="text/javascript" src="fumen2.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <style>

        .glyphtable td{
            border: 1px solid gray;
        }

        .bravura {
            font-family:'Bravura Text';
            /*font-family:'Bravura';*/
            font-size: 24px;
        }

        .desc {
            font-size: 12px;
        }


        @font-face {
        font-family: 'Bravura Text';
        src: url('./assets/fonts/BravuraText.woff') format("woff");
        }

    </style>
    <script type="text/javascript">

    function loadFont(){
        var font1 = new FontFace("Bravura Text", "url(./assets/fonts/BravuraText.woff)");
        font1.load().then(function() {
            document.fonts.add(font1);
            console.log("Font loaded");
        });

        var font2 = new FontFace("Bravura", "url(./assets/fonts/Bravura.woff)");
        font2.load().then(function() {
            document.fonts.add(font2);
            console.log("Font loaded");
        });

    }

    function toHex(v) {
        return '0x' + (('0000' + v.toString(16).toUpperCase()).substr(-4));
    }

    function waitWebfontLoad(){
        return new Promise(function(resolve,reject){
            WebFont.load(
            {
                custom:
                {
                    families: ['Bravura Text']
                },
                loading: function()
                {
                    console.log('loading');
                },
                active: function()
                {
                    console.log('active');
                    resolve(true);
                    //var renderer = new Fumen.MobileRenderer(null, param, canvas_provider);
                    //renderer.render(track);
                },
                inactive: function()
                {
                    console.log('inactive');
                    // Try, just in case
                    //var renderer = new Fumen.MobileRenderer(null, param, canvas_provider);
                    //renderer.render(track);
                    resolve(false); // not reject :)
                }
             });
        });
    }

    function view(){

        var pf = waitWebfontLoad();
        var pmeta = getJSON("./assets/fonts/bravura_metadata.json");

        // Standard smufl  glyphnames mapping. 
        // Note legatures, alternate glyphs are not in the scope of smufl spec.
        // (Just define the range of codes for these gralypcs but does not specify any specific mapping)
        var p = getJSON("./assets/fonts/glyphnames.json"); // From https://raw.githubusercontent.com/w3c/smufl/gh-pages/metadata/glyphnames.json
        Promise.all([pf, pmeta, p]).then(function(rets){
            console.log(rets);
            var fontloaded = rets[0];
            console.log("font loaded : " + fontloaded);
            var metadata = rets[1];
            var glyphnames = rets[2];
            console.log(metadata);
            var codeToNameMap = {};
            for(key in glyphnames){
                var codeInt = parseInt(glyphnames[key].codepoint.replace("U+","0x"));
                codeToNameMap[codeInt] = key;
            }
 

            var s = document.getElementById("all");
            var code = 0xE000;
            var html = "<table class='glyphtable'>";
            var cols = 4;
            var rowhtml = "";
            for(; code < 0xF8FF; ++code){
                var name = (code in codeToNameMap ? codeToNameMap[code] : "");
                var bboxstr = "";
                if(name in metadata.glyphBBoxes){
                    var bbox = metadata.glyphBBoxes[name];
                    bboxstr = "["+(bbox.bBoxSW+"")+"],["+(bbox.bBoxNE+"")+"]";
                }
                rowhtml += ("<td class='bravura'>"+(
                    String.fromCodePoint(0xE014)+
                    String.fromCodePoint(code)+"</td>"+
                    "<td class='desc'>"+toHex(code)+"<br>"+name+" " + bboxstr + "</td>"));
                if(code%cols==cols-1){
                    html += "<tr>"+rowhtml+"</tr>";
                    rowhtml = "";
                }
                
            }
            s.innerHTML = html + "</table>";

            //console.log(codeToNameMap);
            
            var canvas = document.getElementById("canvas");
            Fumen.SetupHiDPICanvas(canvas, 600, 600, 2, 1);
            var ctx = canvas.getContext("2d");
            ctx.font = '29.61px "Bravura Text"';
            ctx.textBaseline = "top";
            ctx.textAlign = "center";
            ypos = 50;
            for(var i = 0; i < 10; ++i){
                ctx.moveTo(0, i*10);
                ctx.lineTo(100, i*10);
                ctx.strokeStyle = "green";
                ctx.stroke();
            }
            ctx.fillText(String.fromCodePoint(0xE014), 10, ypos);
            ctx.fillText(String.fromCodePoint(0xE050), 20, ypos);
            ctx.fillText(String.fromCodePoint(0xE084), 30, ypos);
            //ctx.fillText(String.fromCodePoint(0xF5BA), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF5BB), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF55C), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF55D), 0, 20);
            //ctx.fillText(String.fromCodePoint(0xF57D), 10, ypos);
            //ctx.fillText(String.fromCodePoint(0xF57E), 10, ypos);
            
        });
    }

    function SyncStaff(interval){
        // Synchtornize to 5 line staff with interval assuming "top" align
        //console.log(codeToNameMap);
        var canvas = document.getElementById("canvas");
        Fumen.SetupHiDPICanvas(canvas, 600, 600, 2, 1); // To configure global ratio, firstly call this.

        var memcanvas = document.getElementById("memcanvas");
        Fumen.SetupHiDPICanvas(memcanvas, 600, 600, 2, 1); // To configure global ratio, firstly call this.

        var lineThickNessShift = 0.064; // This is from BBox file aviaalble in Bravura github, as a ratio to interval. This can be considred as a half of line width
        
        // NOTE : Currenly the screening is start from x=y=0. Drawings behid 0,0, are not checked.
        var fontSize = Fumen.getFontSizeFromHeight(interval*4 + lineThickNessShift*interval, 
            "Bravura Text", 
            String.fromCodePoint(0xE014), 
            0.1, {"canvas":memcanvas}); // Get estimated font size.
        
        console.log("font size = "+fontSize);
        var ctx = canvas.getContext("2d");
        ctx.font = fontSize+'px "Bravura Text"';
        ctx.textBaseline = "top";
        var ypos = 50;
        for(var i = 0; i < 5; ++i){
            ctx.moveTo(0, ypos + i*interval);
            ctx.lineTo(500, ypos + i*interval);
            ctx.stroke();
        }
        ctx.fillText(String.fromCodePoint(0xE014), 0, ypos);

        ctx.textAlign = "end";
        ctx.fillText(String.fromCodePoint(0xE080), 0, ypos);

        console.log("Measure text");
        console.log( ctx.measureText(String.fromCodePoint(0xE080)) );
    }

    function getJSON(url) {
        return new Promise(function(resolve, reject){
            var req = new XMLHttpRequest();	
            req.onreadystatechange = function() {
                if(req.readyState == 4 && req.status == 200){
                    var data = JSON.parse(req.responseText);
                    resolve(data);
                }
            };
            req.open("GET", url, false);
            req.send(null);
        });
    }
    </script>
</head>
<body>
    <div><button onclick="view()">View Fonts</button>
        <button onclick="SyncStaff(6)">Sync Staff</button>
        <button onclick="loadFont()">LoadFont</button>
    </div>
    <canvas id="canvas" style="width:100%; height:600px;"></canvas>
    <canvas id="memcanvas"></canvas>
    <p id="all"></p>
</body>
</html>