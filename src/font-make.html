<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>test</title>
    <script type="text/javascript" src="fumen2.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <style>
    </style>
    <script type="text/javascript">

var createSVG = function (charsvg, ex, em) {
    var svgEl = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    var pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");

    pathEl.setAttribute('d', charsvg);
    pathEl.setAttribute('transform', 'translate(0,' + em + ') scale(1, -1)')
    pathEl.style.fill = 'currentColor';

    svgEl.setAttribute('viewBox', '0 0 ' + (ex*1+256) + ' ' + (em*1+256)); //FIXME
    svgEl.appendChild(pathEl);

    return svgEl;
}

function getBBox(charsvg)
{
    var svgEl = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    var pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");

    pathEl.setAttribute('d', charsvg);
    /*pathEl.setAttribute('transform', 'translate(0,' + em + ') scale(1, -1)')
    pathEl.style.fill = 'currentColor';*/

    svgEl.setAttribute('viewBox', '0 0 1024 1024');
    svgEl.appendChild(pathEl);

    document.body.appendChild(svgEl);

    let bbox = svgEl.getBBox();

    document.body.removeChild(svgEl);

    return bbox;
}

function createSvgFile(charsvg, bbox)
{
    var svgFileCont = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>';
    svgFileCont += '<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\
        width="'+bbox.width+'" height="'+bbox.height+'\
        " viewBox="'+bbox.x+' '+(-bbox.height-bbox.y)+' '+bbox.width+' '+bbox.height+'">'; // View box start position is inverted as y scale = -1 applies. (The image is inverted against y=0)
    var path = '<path\
    d="'+charsvg+'"\
    id="path0"\
    transform="scale(1,-1)"\
    style="fill:currentColor" />';
    svgFileCont += path;
    svgFileCont += "</svg>";
    return svgFileCont;
}

function downloadAsSvg(svgdataurl)
{
    const a = document.createElement('a');
    a.href = svgdataurl;
    a.download = 'hoge.svg';
    a.style.display = 'none';
    document.body.appendChild(a); // ※ DOM が構築されてからでないとエラーになる
    a.click();
    document.body.removeChild(a);
}


function svgdataurl(svgfilecont){
    var dataurl = "data:image/svg+xml;utf8,";
    dataurl += svgfilecont;
    return dataurl;
}

function loadAsImage(charsvg)
{
    let bbox = getBBox(charsvg);
    let svgCont = createSvgFile(charsvg, bbox);
    let svgDataUrl = svgdataurl(svgCont);
    //downloadAsSvg(svgDataUrl);

    var p = new Promise(function(resolve, reject) {
        var img = new Image();
        img.src = svgDataUrl;
        img.onload = function() {
            resolve({img:img,bbox:bbox});
        };
    });

    return p;
}

function initCanvas()
{
    //var canvas = document.getElementById("canvas");
    //Fumen.SetupHiDPICanvas(canvas, 600, 600, 2, 1); // To configure global ratio, firstly call this.
    //var ctx = canvas.getContext('2d');
}

function addCanvas(charsvg)
{
    let canvas = document.createElement("canvas");
    document.getElementById("area").appendChild(canvas);
    Fumen.SetupHiDPICanvas(canvas, 50, 50, 2, 1); // To configure global ratio, firstly call this.
    const ctx = canvas.getContext('2d');


    loadAsImage(charsvg)
    .then((ret)=>{
        let img = ret.img;
        let bbox = ret.bbox;
        console.log("loaded");
        let baseSize = 50;
        let ratio = baseSize/img.width;
        ratio = Math.min(ratio, baseSize/img.height);
        // As the viewbox is already setup in svg file itself, start position can be (0,0)
        ctx.drawImage(img, 0, 0, bbox.width, bbox.height, 0, 0,ratio*img.width,ratio*img.height);
    });
}

function loadSvgFont(txt) {
    if (window.DOMParser) {
        parser = new DOMParser();
        xmlDoc = parser.parseFromString(txt, "text/xml");
    } else // Internet Explorer
    {
        xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
        xmlDoc.async = false;
        xmlDoc.loadXML(txt);
    }
    var glyphs = xmlDoc.getElementsByTagName('glyph');
    var src = '';
    fontFamily = xmlDoc.getElementsByTagName('font-face')[0].getAttribute('font-family') || xmlDoc.getElementsByTagName('font')[0].id;

    var ff = xmlDoc.getElementsByTagName('font-face')[0];
    var em = ff.getAttribute('units-per-em');

    src = '';
    var showNum = 10000;
    for (var n = 0; n < glyphs.length; n++) {
        var glyph = glyphs[n];
        if (glyph) {
            var char = glyph.getAttribute('unicode');
            var unicode = char ? (char.charCodeAt(0).toString(16)) : null;
            var charname = glyph.getAttribute('glyph-name');
            var charsvg = glyph.getAttribute('d');
            var ex = glyph.getAttribute('horiz-adv-x') || em;
            if (charsvg) {
                //document.getElementById('svg-' + unicode).appendChild(createSVG(charsvg, ex, em));
                console.log("Loading : " + n);
                addCanvas(charsvg);
            }
            if(n+1 >= showNum) break;
        }
    }
}

function load(){
    const reader = new FileReader();
    reader.onload = function() {
        // 内容表示
        //alert(reader.result);
        initCanvas();
        loadSvgFont(reader.result);
    };

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.svg, text/plain';
    input.onchange = function(event) {
        reader.readAsText(event.target.files[0]);
    };
    input.click();
}

    </script>
</head>
<body>
    <button onclick="load()">Open</button>
    <div id="area"></div>
</body>
</html>