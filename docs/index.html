<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>fumen</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Description">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="//unpkg.com/docsify/lib/themes/vue.css">
  <style type="text/css">
  
@font-face {
   font-family: 'Bravura Text';
   src: url('./assets/fonts/BravuraText.woff') format("woff");
}
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    function fumenStage1(md){
      var startMark = "<!-- fumen:start -->";
      var endMark = "<!-- fumen:end -->";
      var curpos = 0;
      while(true){
        var start = md.indexOf(startMark, curpos);
        if(start < 0) break;
        var end = md.indexOf(endMark, start+startMark.length);
        if(end < 0) break;
        var whole = md.substr(start, end+endMark.length-start);
        var fumenCode = md.substr(start + startMark.length, (end-start-startMark.length));
        var b64 = b64encode(fumenCode);
        var repl = "FUMENSTART"+b64+"FUMENEND";
        md = md.substr(0, start) + repl + md.substr(end+endMark.length); //md.replace(whole, b64);
        curpos = start + repl.length;
      }
      return md;
    }

    function fumenStage2(html){
      var startMark = "FUMENSTART";
      var endMark = "FUMENEND";
      var curpos = 0;
      var canvasIndex = 0;
      while(true){
        var start = html.indexOf(startMark, curpos);
        if(start < 0) break;
        var end = html.indexOf(endMark, start+startMark.length);
        if(end < 0) break;
        var whole = html.substr(start, end+endMark.length-start);
        var b64 = html.substr(start + startMark.length, (end-start-startMark.length));
        var code = b64decode(b64);
        var canvas_div_id = "fumen_canvasdiv_"+canvasIndex;
        var canvas_id = "fumen_canvas_"+canvasIndex;
        var textarea_div_id = "fumen_textareadiv_"+canvasIndex;
        var button = "<input type='radio' name='"+("btn_fumen_"+canvasIndex)+"' value='s' onchange='rb_change("+canvasIndex+")'>Source";
        button += "<input type='radio' name='"+("btn_fumen_"+canvasIndex)+"' value='p' onchange='rb_change("+canvasIndex+")' checked>Image";
        var canvas_div = "<div style='width:100%; background-color:gray; padding:10px; text-align:center;' id='"+canvas_div_id+"'><canvas id='"+canvas_id+"'>"+b64+"</canvas></div>";
        var source_div = "<div style='width:100%; display:none;' id='"+textarea_div_id+"'><textarea style='width:100%; height:100%;'>"+code+"</textarea></div>";
        var repl = button + source_div + canvas_div;
        html = html.substr(0, start) + repl + html.substr(end+endMark.length); //md.replace(whole, b64);
        curpos = start + repl.length;
        ++canvasIndex;
      }
      return html;
    }

    async function fumenStage3(){

      var canvasIndex = 0;
      while(true){
        var canvas = document.getElementById("fumen_canvas_"+canvasIndex);
        if(!canvas) break;
        var b64 = canvas.innerHTML;
        var code = b64decode(b64);
        
        var parser = new Fumen.Parser();
        var track = parser.parse(code);
        if(!track){
          var ctx = canvas.getContext("2d");
          ctx.fillText("Failed to parse",20, 20);
          return;
        }

        var maxWidth = 380;
        var mainwidth = document.getElementById("main").clientWidth;

        var renderer = new Fumen.DefaultRenderer(canvas, {"paper_width":Math.min(maxWidth, mainwidth), "paper_height":0});
        await renderer.render(track).then(function(r){
          var canvasdiv = document.getElementById("fumen_canvasdiv_"+canvasIndex);
          var textareadiv = document.getElementById("fumen_textareadiv_"+canvasIndex);
          textareadiv.style.height = r.height + "px";
        })

        ++canvasIndex;
      }
    }

    function rb_change(idx){
      //alert(idx);
      var btns = document.getElementsByName("btn_fumen_"+idx);

      if(btns[0].checked){
        // source
        document.getElementById("fumen_textareadiv_"+idx).style.display = "inherit";
        document.getElementById("fumen_canvasdiv_"+idx).style.display = "none";
      }else{
        // image
        document.getElementById("fumen_textareadiv_"+idx).style.display = "none";
        document.getElementById("fumen_canvasdiv_"+idx).style.display = "inherit";
      }
    }

    function b64encode(text){
      return btoa(encodeURIComponent(text));
    }

    function b64decode(b64){
      return decodeURIComponent(atob(b64));
    }

    window.$docsify = {
      name: 'fumen',
      repo: 'https://github.com/hbjpn/fumen2',
      loadSidebar: true,
      subMaxLevel: 4,
      plugins: [
        function(hook, vm){
          hook.beforeEach(function(content){
            //console.log(content);
            return fumenStage1(content);
          });
          hook.afterEach(function(html){
            //console.log(html);
            //console.log(html);
            //return html + "<a href='http://google.co.jp/'>Google</a>";
            
            //fumenStage1(html);
            return fumenStage2(html);
            //return html;
          });
          hook.doneEach(function() {
            // Invoked each time after the data is fully loaded, no arguments,
            // ...
            fumenStage3();
          });
        }
      ]
    }
  </script>
  <script src="//unpkg.com/docsify/lib/docsify.min.js"></script>
  <script src="fumen2.js"></script>
</body>
</html>
